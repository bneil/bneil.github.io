<!doctype html><html><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>opentofu-for-gcp-funcs - bneil.me</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Just thought id try some deployment"><meta property="og:image" content><meta property="og:url" content="https://bneil.me/posts/2024-09-17-opentofu-for-gcp-funcs/"><meta property="og:site_name" content="bneil.me"><meta property="og:title" content="opentofu-for-gcp-funcs"><meta property="og:description" content="Just thought id try some deployment"><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-09-18T04:17:59+00:00"><meta property="article:modified_time" content="2024-09-17T22:59:49-06:00"><meta property="article:tag" content="Opentofu"><meta property="article:tag" content="Golang"><meta name=twitter:card content="summary"><meta name=twitter:title content="opentofu-for-gcp-funcs"><meta name=twitter:description content="Just thought id try some deployment"><script src=https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js></script><link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:ital,wght@1,500&display=swap" rel=stylesheet><link href="https://fonts.googleapis.com/css2?family=Fira+Sans&display=swap" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Roboto+Mono" rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://bneil.me/css/main.ac08a4c9714baa859217f92f051deb58df2938ec352b506df655005dcaf98cc0.css><link id=darkModeStyle rel=stylesheet type=text/css href=https://bneil.me/css/dark.f7f653818008804da30d1735284e5eb1e9c3339332869aa296658b199bea7809.css disabled></head><body><div class=content><header><div class=main><a href=https://bneil.me/>bneil.me</a></div><nav><a href=/>Home</a>
<a href=/contact>Contact</a>
<a href=/resume>Resume</a>
<a href=/about>About</a>
<a href=/posts>Blog</a>
<a href=/tags/notes>Notes</a>
<a href=/now>Now</a>
| <span id=dark-mode-toggle onclick=toggleTheme()></span>
<script src=https://bneil.me/js/themetoggle.js></script></nav></header><main><article class=h-entry><div class=title><h1 class="title p-name">opentofu-for-gcp-funcs</h1><div class=meta>Posted on Sep 18, 2024</div></div><section class="body e-content"><h2 id=opentofu-and-gcp-functions>OpenTofu and GCP Functions</h2><p>Had a few minutes so thought id see how to deploy a function using open tofu.</p><p>for this example, please use the alias</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>alias tf=&#39;tofu&#39;
</span></span></code></pre></div><p>The directories should look like</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>main.tf
</span></span><span style=display:flex><span>function/main.tf
</span></span></code></pre></div><p>Setting up the main.tf file. I left things in one file and also forgo&rsquo;d the variables file.
Again, just wanted to get some timings around deployments</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript3 data-lang=gdscript3><span style=display:flex><span><span style=color:#75715e># Configure your gcp </span>
</span></span><span style=display:flex><span>provider <span style=color:#e6db74>&#34;google&#34;</span> {
</span></span><span style=display:flex><span>  project <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;YOUR_PROJECT_ID_HERE&#34;</span>
</span></span><span style=display:flex><span>  region  <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;us-central1&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>resource <span style=color:#e6db74>&#34;google_storage_bucket&#34;</span> <span style=color:#e6db74>&#34;sandbox_bucket&#34;</span> {
</span></span><span style=display:flex><span>  name     <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;UNIQUE_BUCKET_NAME&#34;</span>
</span></span><span style=display:flex><span>  location <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;US&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Makes the zip file</span>
</span></span><span style=display:flex><span>data <span style=color:#e6db74>&#34;archive_file&#34;</span> <span style=color:#e6db74>&#34;function_zip&#34;</span> {
</span></span><span style=display:flex><span>  type        <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;zip&#34;</span>
</span></span><span style=display:flex><span>  source_dir  <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;${path.module}/function&#34;</span>
</span></span><span style=display:flex><span>  output_path <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;${path.module}/function.zip&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Uploads</span>
</span></span><span style=display:flex><span>resource <span style=color:#e6db74>&#34;google_storage_bucket_object&#34;</span> <span style=color:#e6db74>&#34;function_zip&#34;</span> {
</span></span><span style=display:flex><span>  name   <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;function-${data.archive_file.function_zip.output_md5}.zip&#34;</span>
</span></span><span style=display:flex><span>  bucket <span style=color:#f92672>=</span> google_storage_bucket<span style=color:#f92672>.</span>sandbox_bucket<span style=color:#f92672>.</span>name
</span></span><span style=display:flex><span>  source <span style=color:#f92672>=</span> data<span style=color:#f92672>.</span>archive_file<span style=color:#f92672>.</span>function_zip<span style=color:#f92672>.</span>output_path
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Generates the cloud function</span>
</span></span><span style=display:flex><span>resource <span style=color:#e6db74>&#34;google_cloudfunctions_function&#34;</span> <span style=color:#e6db74>&#34;function&#34;</span> {
</span></span><span style=display:flex><span>  name        <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;ping&#34;</span>
</span></span><span style=display:flex><span>  description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;the ping is real&#34;</span>
</span></span><span style=display:flex><span>  runtime     <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;go116&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  available_memory_mb   <span style=color:#f92672>=</span> <span style=color:#ae81ff>128</span>
</span></span><span style=display:flex><span>  source_archive_bucket <span style=color:#f92672>=</span> google_storage_bucket<span style=color:#f92672>.</span>sandbox_bucket<span style=color:#f92672>.</span>name
</span></span><span style=display:flex><span>  source_archive_object <span style=color:#f92672>=</span> google_storage_bucket_object<span style=color:#f92672>.</span>function_zip<span style=color:#f92672>.</span>name
</span></span><span style=display:flex><span>  trigger_http          <span style=color:#f92672>=</span> true
</span></span><span style=display:flex><span>  entry_point           <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Ping&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># IAM entry for all users to invoke the function</span>
</span></span><span style=display:flex><span>resource <span style=color:#e6db74>&#34;google_cloudfunctions_function_iam_member&#34;</span> <span style=color:#e6db74>&#34;invoker&#34;</span> {
</span></span><span style=display:flex><span>  project        <span style=color:#f92672>=</span> google_cloudfunctions_function<span style=color:#f92672>.</span>function<span style=color:#f92672>.</span>project
</span></span><span style=display:flex><span>  region         <span style=color:#f92672>=</span> google_cloudfunctions_function<span style=color:#f92672>.</span>function<span style=color:#f92672>.</span>region
</span></span><span style=display:flex><span>  cloud_function <span style=color:#f92672>=</span> google_cloudfunctions_function<span style=color:#f92672>.</span>function<span style=color:#f92672>.</span>name
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  role   <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;roles/cloudfunctions.invoker&#34;</span>
</span></span><span style=display:flex><span>  member <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;allUsers&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>output <span style=color:#e6db74>&#34;function_url&#34;</span> {
</span></span><span style=display:flex><span>  description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Curl to test&#34;</span>
</span></span><span style=display:flex><span>  value       <span style=color:#f92672>=</span> google_cloudfunctions_function<span style=color:#f92672>.</span>function<span style=color:#f92672>.</span>https_trigger_url
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The test golang file looks like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript3 data-lang=gdscript3><span style=display:flex><span>package function
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>import (
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;encoding/json&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;net/http&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;time&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>//</span> Response represents the JSON structure we<span style=color:#e6db74>&#39;ll return</span>
</span></span><span style=display:flex><span>type Response struct {
</span></span><span style=display:flex><span>	Message   string    <span style=color:#960050;background-color:#1e0010>`</span>json:<span style=color:#e6db74>&#34;message&#34;</span><span style=color:#960050;background-color:#1e0010>`</span>
</span></span><span style=display:flex><span>	Timestamp time<span style=color:#f92672>.</span>Time <span style=color:#960050;background-color:#1e0010>`</span>json:<span style=color:#e6db74>&#34;timestamp&#34;</span><span style=color:#960050;background-color:#1e0010>`</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>//</span> Ping is an HTTP Cloud Function that returns a JSON response<span style=color:#f92672>.</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> Ping(w http<span style=color:#f92672>.</span>ResponseWriter, r <span style=color:#f92672>*</span>http<span style=color:#f92672>.</span>Request) {
</span></span><span style=display:flex><span>	response :<span style=color:#f92672>=</span> Response{
</span></span><span style=display:flex><span>		Message:   <span style=color:#e6db74>&#34;pong&#34;</span>,
</span></span><span style=display:flex><span>		Timestamp: time<span style=color:#f92672>.</span>Now(),
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	w<span style=color:#f92672>.</span>Header()<span style=color:#f92672>.</span>Set(<span style=color:#e6db74>&#34;Content-Type&#34;</span>, <span style=color:#e6db74>&#34;application/json&#34;</span>)
</span></span><span style=display:flex><span>	json<span style=color:#f92672>.</span>NewEncoder(w)<span style=color:#f92672>.</span>Encode(response)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The actual deployment wan&rsquo;t bad.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>tf init
</span></span><span style=display:flex><span>tf plan
</span></span></code></pre></div><p>then the famous <code>tf apply</code>. I ran into some issues</p><ol><li>needed to use <code>gcloud auth application-default login</code> to set my email to the right one</li><li>needed to enable artifactorregistry? <code>gcloud services enable artifactregistry.googleapis.com</code></li></ol><p>But once those were done, the first run wasn&rsquo;t bad, just under 2m.</p><p>Verified using the fantastic httpie:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>➜  http https://MYSTERY.cloudfunctions.net/ping
</span></span><span style=display:flex><span>HTTP/1.1 200 OK
</span></span><span style=display:flex><span>Alt-Svc: h3=&#34;:443&#34;; ma=2592000,h3-29=&#34;:443&#34;; ma=2592000
</span></span><span style=display:flex><span>Content-Length: 64
</span></span><span style=display:flex><span>Content-Type: application/json
</span></span><span style=display:flex><span>Date: Wed, 18 Sep 2024 04:53:29 GMT
</span></span><span style=display:flex><span>Function-Execution-Id: 50gjuelrir3x
</span></span><span style=display:flex><span>Server: Google Frontend
</span></span><span style=display:flex><span>X-Cloud-Trace-Context: 5e1195a6f11deb78f851265f4a8ea913;o=1
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    &#34;message&#34;: &#34;pong&#34;,
</span></span><span style=display:flex><span>    &#34;timestamp&#34;: &#34;2024-09-18T04:53:29.562205302Z&#34;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></section><hr>### comments
<script src=https://utteranc.es/client.js repo=bneil/bneil.github.io issue-term=pathname theme=preferred-color-scheme crossorigin=anonymous async></script><hr>### webmention section<div class=manual-webmention><p>Have you written a <a href=https://indieweb.org/responses>response</a> to this post? Put the url here:</p><form id=manual-webmention action=https://webmention.io/bneil.me/webmention method=post><input type=url name=source>
<input type=hidden name=target value=https://bneil.me/posts/2024-09-17-opentofu-for-gcp-funcs/>
<input type=submit name=submit value=Comment></form></form></div><br><div></div><small>permalink: <a class=u-url href=https://bneil.me/posts/2024-09-17-opentofu-for-gcp-funcs/>https://bneil.me/posts/2024-09-17-opentofu-for-gcp-funcs/</a></small><div class=post-tags><nav class="nav tags"><ul class=tags><li>&nbsp;<a href=/tags/opentofu>opentofu</a></li><li>&nbsp;<a href=/tags/golang>golang</a></li></ul></nav></div></article></main><hr class=halloween-hr style=width:100%><footer style=border-top:0><a class=soc rel=me href=https://github.com/bneil title=Github><i data-feather=github></i></a>|<a class=soc rel=me href=https://twitter.com/benneil/ title=Twitter><i data-feather=twitter></i></a>|<a class=soc rel=me href=https://www.linkedin.com/in/readyplayer1/ title=LinkedIn><i data-feather=linkedin></i></a>|<a class=soc rel=me href=mailto:ben@neil-concepts.com title=Email><i data-feather=mail></i></a>|<a class=soc rel=me href=https://coderwall.com/bneil title=Coderwall><i data-feather=code></i></a>|<a class=soc rel=me href=https://medium.com/@bneil/about title=Medium><i data-feather=book></i></a>|<a class=soc rel=me href=https://bneil.me/index.xml title=rss><i data-feather=rss></i></a>|⚡️
2024 © bneil | site was last updated: Nov 22, 2024</footer><link rel=webmention href=https://webmention.io/bneil.me/webmention><link rel=pingback href=https://webmention.io/bneil.me/xmlrpc><div class=h-card style=display:none><span class=p-name>Ben Neil</span>
<span class=p-given-name>Ben</span>
<abbr class=p-additional-name>E.</abbr>
<span class=p-family-name>Neil</span>
<span class=p-nickname>bneil</span> (IRC)
<img class=u-photo src=https://bneil.me/images/avatar.gif>
<a class=u-url href=acct:bneil@bneil.me></a><a class=u-email href=mailto:ben@neil-concepts.com>e</a><div class=p-category>programmer</div><div class=p-note>Automation Mechanic</div><a class="u-url u-uid" href=https://bneil.me/></a></div><script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "cc4d2eca67bc471d83269a9e66e60551"}'></script><script>var clicky_site_ids=clicky_site_ids||[];clicky_site_ids.push(101323590)</script><script async src=//static.getclicky.com/js></script><noscript><p><img alt=Clicky width=1 height=1 src=//in.getclicky.com/101323590ns.gif></p></noscript><script async src=https://analytics.umami.is/script.js data-website-id=438d75f5-c8b9-4507-b617-9c4e1f8cdbe1></script><script>feather.replace()</script><div class=stars><div class=star></div><div class=star></div><div class=star></div><div class=star></div><div class=star></div><div class=star></div><div class=star></div><div class=star></div><div class=star></div><div class=star></div><div class=star></div><div class=star></div><div class=star></div><div class=star></div><div class=star></div><div class=star></div><div class=star></div><div class=star></div><div class=star></div><div class=star></div><div class=star></div><div class=star></div><div class=star></div><div class=star></div><div class=star></div><div class=star></div><div class=star></div><div class=star></div><div class=star></div><div class=star></div><div class=star></div><div class=star></div><div class=star></div><div class=star></div><div class=star></div><div class=star></div><div class=star></div><div class=star></div><div class=star></div><div class=star></div><div class=star></div><div class=star></div><div class=star></div><div class=star></div><div class=star></div><div class=star></div><div class=star></div><div class=star></div><div class=star></div><div class=star></div></div></div></body></html>
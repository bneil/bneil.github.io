<!doctype html><html dir=ltr lang=en data-theme><head><title>| Audit Service - RDS</title><meta charset=utf-8><meta name=generator content="Hugo 0.84.1"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><meta name=description content="Part two in creating an audit service"><link rel=stylesheet href=/css/main.min.f79a5de55310cc058fc81804d033ddb955937d778bd533d9ea05b1c798501013.css integrity="sha256-95pd5VMQzAWPyBgE0DPduVWTfXeL1TPZ6gWxx5hQEBM=" crossorigin=anonymous type=text/css><link rel=stylesheet href=/css/markupHighlight.min.f798cbda9aaa38f89eb38be6414bd082cfd71a6780375cbf67b6d2fb2b96491e.css integrity="sha256-95jL2pqqOPies4vmQUvQgs/XGmeAN1y/Z7bS+yuWSR4=" crossorigin=anonymous type=text/css><link rel=stylesheet href=/css/override.min.768972ffa848ede51abb9ee7e9e8d26e7604d2fc5301254a7c14d8928fa099b9.css integrity="sha256-doly/6hI7eUau57n6ejSbnYE0vxTASVKfBTYko+gmbk=" crossorigin=anonymous media=screen><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css integrity="sha512-+4zCK9k+qNFUR5X+cKL9EIR+ZOhtIloNl9GIKS57V1MyNsYpYcUrUeQc9vNfzsWfV28IaLL3i96P9sdNyeRssA==" crossorigin=anonymous><link rel="shortcut icon" href=/favicon.ico type=image/x-icon><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=canonical href=/posts/2021-05-28_rds-audit-service/><script type=text/javascript src=/js/anatole-header.min.0c05c0a90d28c968a1cad4fb31abd0b8e1264e788ccefed022ae1d3b6f627514.js integrity="sha256-DAXAqQ0oyWihytT7MavQuOEmTniMzv7QIq4dO29idRQ=" crossorigin=anonymous></script><script type=text/javascript src=/js/anatole-theme-switcher.min.7fd87181cdd7e8413aa64b6867bb32f3a8dc242e684fc7d5bbb9f600dbc2b6eb.js integrity="sha256-f9hxgc3X6EE6pktoZ7sy86jcJC5oT8fVu7n2ANvCtus=" crossorigin=anonymous></script><meta name=twitter:card content="summary"><meta name=twitter:title content="Audit Service - RDS"><meta name=twitter:description content="Part two in creating an audit service"></head><body><div class="sidebar animated fadeInDown"><div class=logo-title><div class="title h-card"><img class=u-photo src=/images/avatar.gif alt="profile picture"><h3 title="Benjamin Neil"><a class="p-name u-url" rel=me href=https://bneil.me/>Benjamin Neil</a></h3><div class=description><p class=p-note>AUTOMATION MECHANIC<br>writer and coder<br></p></div></div></div><ul class=social-links><li><a class=u-url href=https://github.com/bneil rel=me aria-label=Github><i class="fab fa-github fa-2x" aria-hidden=true></i></a></li><li><a class=u-url href=https://twitter.com/benneil/ rel=me aria-label=Twitter><i class="fab fa-twitter fa-2x" aria-hidden=true></i></a></li><li><a class=u-url href=https://www.linkedin.com/in/readyplayer1/ rel=me aria-label=LinkedIn><i class="fab fa-linkedin fa-2x" aria-hidden=true></i></a></li><li><a class=u-url href=mailto:ben@neil-concepts.com rel=me aria-label=Email><i class="fas fa-envelope fa-2x" aria-hidden=true></i></a></li><li><a class=u-url href=https://coderwall.com/bneil rel=me aria-label=Coderwall><i class="fas fa-code fa-2x" aria-hidden=true></i></a></li><li><a class=u-url href=https://medium.com/@bneil/about rel=me aria-label=Medium><i class="fab fa-medium fa-2x" aria-hidden=true></i></a></li><li><a class=u-url href=https://bneil.me/post/index.xml rel=me aria-label=rss><i class="fas fa-rss fa-2x" aria-hidden=true></i></a></li></ul><div class=footer><span style=font-weight:700>Site Was Last Modified:</span> Jun 27, 2021<div class=by_farbox>&copy; 2000-2021</div><br><p>Built with <a href=https://gohugo.io>Hugo</a>.<br>Theme is <a href=https://themes.gohugo.io/anatole/>Anatole</a></p><b id=license>The content of this site is licensed under <a rel=license href=http://creativecommons.org/licenses/by-nc-sa/3.0/>Creative Commons</a>.</b></div></div><div class=main><div class="page-top animated fadeInDown"><a role=button class=navbar-burger data-target=navMenu aria-label=menu aria-expanded=false><span aria-hidden=true></span><span aria-hidden=true></span><span aria-hidden=true></span></a><ul class=nav id=navMenu><li><a href=/ title>Home</a></li><li><a href=/contact title>Contact</a></li><li><a href=/resume title>Resume</a></li><li><a href=/about title>About</a></li><li><a href=/posts title>Blog</a></li><li><a href=/tags/notes title>Notes</a></li><li><a href=/now title>Now</a></li><li class=theme-switch-item><a class=theme-switch title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></li></ul></div><div class=autopagerize_page_element><div class=content><div class="post animated fadeInDown"><article class=h-entry><div class=post-content><div class=post-title><h3>Audit Service - RDS</h3><a rel=author class="p-author h-card" href=#></a><div class=info><em class="fas fa-calendar-day"></em><span class=date><time class=dt-published>Fri, 28 May 2021 11:39:43 -0600</time></span>
<em class="fas fa-stopwatch"></em><span class=reading-time>3-minute read</span></div></div><div class="e-content p-name"><h1 id=audit-service-or-round-2-fight>Audit Service or Round 2 Fight</h1><h2 id=description>Description</h2><p>When I started to think more critically about how interactions would work inside
dynamodb for auditing I quickly learned about pain. Lots and lots of pain. Including
the fact id probably end up having to use dynamodb streams and couple that with elasticsearch.
So im not going to even entertain that idea and am going down the ol trusty sql route.</p><h1 id=creating-the-database>Creating the database</h1><p>Im still on an older version of terraform, so public shamming for being on 0.12.6.</p><h2 id=iaac-section>IaaC section</h2><div class=highlight><pre class=chroma><code class=language-shell data-lang=shell>tfenv install 0.12.6
tfenv use 0.12.6
</code></pre></div><p>I had already done an <code>tf import</code> from a previous db table, so I just copied and pasted then
modified the database values. Note the xxxx&rsquo;s below are redacted text so change that if you
are copy and pasting.</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>resource &#34;random_password&#34; &#34;password&#34; {
  length           = 16
  special          = true
  override_special = &#34;_%@&#34;
}

resource &#34;aws_db_instance&#34; &#34;aduit_db&#34; {
    allocated_storage                     = 20
    auto_minor_version_upgrade            = true
    availability_zone                     = &#34;xxxxx&#34;
    backup_retention_period               = 7
    backup_window                         = &#34;09:12-09:42&#34;
    copy_tags_to_snapshot                 = true
    db_subnet_group_name                  = &#34;default-vpc-d7c845b3&#34;
    deletion_protection                   = true
    enabled_cloudwatch_logs_exports       = []
    engine                                = &#34;postgres&#34;
    engine_version                        = &#34;12.5&#34;
    iam_database_authentication_enabled   = false
    identifier                            = &#34;audit&#34;
    instance_class                        = &#34;db.t3.micro&#34;
    max_allocated_storage                 = 1000
    monitoring_interval                   = 60
    multi_az                              = false
    option_group_name                     = &#34;default:postgres-12&#34;
    parameter_group_name                  = &#34;default.postgres12&#34;
    performance_insights_enabled          = true
    performance_insights_retention_period = 7
    port                                  = 5432
    publicly_accessible                   = true
    security_group_names                  = []
    skip_final_snapshot                   = true
    storage_encrypted                     = true
    storage_type                          = &#34;gp2&#34;
    tags                                  = {}
    username                              = &#34;postgres&#34;
    password                              = random_password.password.result
    vpc_security_group_ids                = [
        &#34;sg-0267a264&#34;,
    ]

    timeouts {}
}

output &#34;password&#34; {
  description = &#34;The password is:&#34;
  value = random_password.password.*.result
}
</code></pre></div><h2 id=goose-time--local-dev>Goose time / Local Dev</h2><p>Inside the project, im creating a table&rsquo;s folder then setting up <a href=https://github.com/pressly/goose>goose</a>.
its as easy as running <code>go get -u github.com/pressly/goose/cmd/goose</code>. Also, I needed to set up a testing
postgres instance.</p><h3 id=quick-docker-setup>Quick Docker Setup</h3><p>localdb.compose.yaml</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;3.5&#39;</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>pgdata</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span><span class=w>
</span><span class=w></span><span class=nt>services</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>db</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>postgres</span><span class=w>
</span><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=m>5432</span><span class=p>:</span><span class=m>5432</span><span class=w>
</span><span class=w>    </span><span class=nt>environment</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=l>POSTGRES_USER=postgres</span><span class=w>
</span><span class=w>      </span>- <span class=l>POSTGRES_PASSWORD=shhh</span><span class=w>
</span><span class=w>      </span>- <span class=l>POSTGRES_DB=audit_dev</span><span class=w>
</span><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=l>pgdata:/var/lib/postgresql/data</span><span class=w>
</span><span class=w>
</span><span class=w>  </span><span class=nt>adminer</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>adminer</span><span class=w>
</span><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=m>8000</span><span class=p>:</span><span class=m>8080</span><span class=w>
</span></code></pre></div><p>then run <code>docker-compose -f localdb.compose.yaml up</code> and you should have a local copy of postgres running</p><h3 id=back-to-goose>Back to goose</h3><p>Please note I cheated and created the database manually, I just don&rsquo;t like accidentally dropping the entire db if
it can be helped. Otherwise&mldr; a quick mkdir for &lsquo;tables&rsquo; and then added</p><p>001_create_events_table.sql</p><div class=highlight><pre class=chroma><code class=language-shell data-lang=shell>-- +goose Up
-- +goose StatementBegin
SELECT <span class=s1>&#39;up SQL query&#39;</span><span class=p>;</span>
CREATE EXTENSION IF NOT EXISTS <span class=s2>&#34;uuid-ossp&#34;</span><span class=p>;</span>

CREATE TABLE events <span class=o>(</span>
    id            INT NOT NULL PRIMARY KEY GENERATED ALWAYS AS IDENTITY,
    user_id       UUID NOT NULL,
    company_name  VARCHAR<span class=o>(</span>255<span class=o>)</span> NOT NULL,
    event         TEXT NOT NULL,
    created_on    TIMESTAMP NOT NULL,
    updated_on    TIMESTAMP NOT NULL
<span class=o>)</span><span class=p>;</span>
-- +goose StatementEnd

-- +goose Down
-- +goose StatementBegin
SELECT <span class=s1>&#39;down SQL query&#39;</span><span class=p>;</span>
DROP TABLE events<span class=p>;</span>
-- +goose StatementEnd
</code></pre></div><p><em>The extension is for using UUID</em></p><p>So now that the database can be mucked with it was easy enough to run
<code>goose postgres "user=postgres password=${TEMP_PGPASS} dbname=audit_dev sslmode=disable" up</code>
I played around with that for a bit just because migration tooling is neat.</p><h2 id=the-end>The end?</h2><p>Now I just need to write the code for the migration of older audit records. So if any neat code comes up, I&rsquo;ll write it
on here.</p><small><strong>This Post Was Last Updated:</strong> Fri, 25 Jun 2021 10:21:39 -0600</small></div></div></article><div class=post-footer><div class=info><span class=separator><a class=category href=/categories/coding/>coding</a></span>
<span class=separator><a class=tag href=/tags/rds/>rds</a><a class=tag href=/tags/aws/>aws</a><a class=tag href=/tags/golang/>golang</a></span></div></div></div><link rel=webmention href=https://webmention.io/bneil.me/webmention><link rel=pingback href=https://webmention.io/bneil.me/xmlrpc></div></div></div><script type=text/javascript src=/js/medium-zoom.min.83cb1dd5fea8d42d87d1e601a07faa73089ad0ef9ccfe5daf6041289ebcc4e46.js integrity="sha256-g8sd1f6o1C2H0eYBoH+qcwia0O+cz+Xa9gQSievMTkY=" crossorigin=anonymous></script><script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "cc4d2eca67bc471d83269a9e66e60551"}'></script></body></html>
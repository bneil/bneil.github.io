<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Audit Service - RDS - bneil.me</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Part two in creating an audit service"><meta property="og:image" content><meta property="og:title" content="Audit Service - RDS"><meta property="og:description" content="Part two in creating an audit service"><meta property="og:type" content="article"><meta property="og:url" content="https://bneil.me/posts/2021-05-28_rds-audit-service/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-05-28T11:39:43-06:00"><meta property="article:modified_time" content="2021-06-25T10:21:39-06:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Audit Service - RDS"><meta name=twitter:description content="Part two in creating an audit service"><script src=https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js></script>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:ital,wght@1,500&display=swap" rel=stylesheet><link href="https://fonts.googleapis.com/css2?family=Fira+Sans&display=swap" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Roboto+Mono" rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://bneil.me/css/main.2f9b5946627215dc1ae7fa5f82bfc9cfcab000329136befeea5733f21e77d68f.css><link id=darkModeStyle rel=stylesheet type=text/css href=https://bneil.me/css/dark.726cd11ca6eb7c4f7d48eb420354f814e5c1b94281aaf8fd0511c1319f7f78a4.css><link rel=stylesheet type=text/css href=https://bneil.me/css/update.ff395c244743e365abad95975c909c1514e437a2ec898348ec9156489a6f238a.css></head><body><div class=content><header><div class=main><a href=https://bneil.me>bneil.me</a></div><nav><a href=/>Home</a>
<a href=/contact>Contact</a>
<a href=/resume>Resume</a>
<a href=/about>About</a>
<a href=/posts>Blog</a>
<a href=/tags/notes>Notes</a>
<a href=/now>Now</a></nav></header><main><article class=h-entry><div class=title><h1 class="title p-name">Audit Service - RDS</h1><div class=meta>Posted on May 28, 2021</div></div><section class="body e-content"><h1 id=audit-service-or-round-2-fight>Audit Service or Round 2 Fight</h1><h2 id=description>Description</h2><p>When I started to think more critically about how interactions would work inside
dynamodb for auditing I quickly learned about pain. Lots and lots of pain. Including
the fact id probably end up having to use dynamodb streams and couple that with elasticsearch.
So im not going to even entertain that idea and am going down the ol trusty sql route.</p><h1 id=creating-the-database>Creating the database</h1><p>Im still on an older version of terraform, so public shamming for being on 0.12.6.</p><h2 id=iaac-section>IaaC section</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>tfenv install 0.12.6
</span></span><span style=display:flex><span>tfenv use 0.12.6
</span></span></code></pre></div><p>I had already done an <code>tf import</code> from a previous db table, so I just copied and pasted then
modified the database values. Note the xxxx&rsquo;s below are redacted text so change that if you
are copy and pasting.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>resource &#34;random_password&#34; &#34;password&#34; {
</span></span><span style=display:flex><span>  length           = 16
</span></span><span style=display:flex><span>  special          = true
</span></span><span style=display:flex><span>  override_special = &#34;_%@&#34;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>resource &#34;aws_db_instance&#34; &#34;aduit_db&#34; {
</span></span><span style=display:flex><span>    allocated_storage                     = 20
</span></span><span style=display:flex><span>    auto_minor_version_upgrade            = true
</span></span><span style=display:flex><span>    availability_zone                     = &#34;xxxxx&#34;
</span></span><span style=display:flex><span>    backup_retention_period               = 7
</span></span><span style=display:flex><span>    backup_window                         = &#34;09:12-09:42&#34;
</span></span><span style=display:flex><span>    copy_tags_to_snapshot                 = true
</span></span><span style=display:flex><span>    db_subnet_group_name                  = &#34;default-vpc-d7c845b3&#34;
</span></span><span style=display:flex><span>    deletion_protection                   = true
</span></span><span style=display:flex><span>    enabled_cloudwatch_logs_exports       = []
</span></span><span style=display:flex><span>    engine                                = &#34;postgres&#34;
</span></span><span style=display:flex><span>    engine_version                        = &#34;12.5&#34;
</span></span><span style=display:flex><span>    iam_database_authentication_enabled   = false
</span></span><span style=display:flex><span>    identifier                            = &#34;audit&#34;
</span></span><span style=display:flex><span>    instance_class                        = &#34;db.t3.micro&#34;
</span></span><span style=display:flex><span>    max_allocated_storage                 = 1000
</span></span><span style=display:flex><span>    monitoring_interval                   = 60
</span></span><span style=display:flex><span>    multi_az                              = false
</span></span><span style=display:flex><span>    option_group_name                     = &#34;default:postgres-12&#34;
</span></span><span style=display:flex><span>    parameter_group_name                  = &#34;default.postgres12&#34;
</span></span><span style=display:flex><span>    performance_insights_enabled          = true
</span></span><span style=display:flex><span>    performance_insights_retention_period = 7
</span></span><span style=display:flex><span>    port                                  = 5432
</span></span><span style=display:flex><span>    publicly_accessible                   = true
</span></span><span style=display:flex><span>    security_group_names                  = []
</span></span><span style=display:flex><span>    skip_final_snapshot                   = true
</span></span><span style=display:flex><span>    storage_encrypted                     = true
</span></span><span style=display:flex><span>    storage_type                          = &#34;gp2&#34;
</span></span><span style=display:flex><span>    tags                                  = {}
</span></span><span style=display:flex><span>    username                              = &#34;postgres&#34;
</span></span><span style=display:flex><span>    password                              = random_password.password.result
</span></span><span style=display:flex><span>    vpc_security_group_ids                = [
</span></span><span style=display:flex><span>        &#34;sg-0267a264&#34;,
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    timeouts {}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>output &#34;password&#34; {
</span></span><span style=display:flex><span>  description = &#34;The password is:&#34;
</span></span><span style=display:flex><span>  value = random_password.password.*.result
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=goose-time--local-dev>Goose time / Local Dev</h2><p>Inside the project, im creating a table&rsquo;s folder then setting up <a href=https://github.com/pressly/goose>goose</a>.
its as easy as running <code>go get -u github.com/pressly/goose/cmd/goose</code>. Also, I needed to set up a testing
postgres instance.</p><h3 id=quick-docker-setup>Quick Docker Setup</h3><p>localdb.compose.yaml</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>version</span>: <span style=color:#e6db74>&#39;3.5&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>pgdata</span>: {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>services</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>db</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>postgres</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>5432</span>:<span style=color:#ae81ff>5432</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>environment</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>POSTGRES_USER=postgres</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>POSTGRES_PASSWORD=shhh</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>POSTGRES_DB=audit_dev</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>pgdata:/var/lib/postgresql/data</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>adminer</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>adminer</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>8000</span>:<span style=color:#ae81ff>8080</span>
</span></span></code></pre></div><p>then run <code>docker-compose -f localdb.compose.yaml up</code> and you should have a local copy of postgres running</p><h3 id=back-to-goose>Back to goose</h3><p>Please note I cheated and created the database manually, I just don&rsquo;t like accidentally dropping the entire db if
it can be helped. Otherwise&mldr; a quick mkdir for &rsquo;tables&rsquo; and then added</p><p>001_create_events_table.sql</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>-- +goose Up
</span></span><span style=display:flex><span>-- +goose StatementBegin
</span></span><span style=display:flex><span>SELECT <span style=color:#e6db74>&#39;up SQL query&#39;</span>;
</span></span><span style=display:flex><span>CREATE EXTENSION IF NOT EXISTS <span style=color:#e6db74>&#34;uuid-ossp&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>CREATE TABLE events <span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>    id            INT NOT NULL PRIMARY KEY GENERATED ALWAYS AS IDENTITY,
</span></span><span style=display:flex><span>    user_id       UUID NOT NULL,
</span></span><span style=display:flex><span>    company_name  VARCHAR<span style=color:#f92672>(</span>255<span style=color:#f92672>)</span> NOT NULL,
</span></span><span style=display:flex><span>    event         TEXT NOT NULL,
</span></span><span style=display:flex><span>    created_on    TIMESTAMP NOT NULL,
</span></span><span style=display:flex><span>    updated_on    TIMESTAMP NOT NULL
</span></span><span style=display:flex><span><span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span>-- +goose StatementEnd
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>-- +goose Down
</span></span><span style=display:flex><span>-- +goose StatementBegin
</span></span><span style=display:flex><span>SELECT <span style=color:#e6db74>&#39;down SQL query&#39;</span>;
</span></span><span style=display:flex><span>DROP TABLE events;
</span></span><span style=display:flex><span>-- +goose StatementEnd
</span></span></code></pre></div><p><em>The extension is for using UUID</em></p><p>So now that the database can be mucked with it was easy enough to run
<code>goose postgres "user=postgres password=${TEMP_PGPASS} dbname=audit_dev sslmode=disable" up</code>
I played around with that for a bit just because migration tooling is neat.</p><h2 id=the-end>The end?</h2><p>Now I just need to write the code for the migration of older audit records. So if any neat code comes up, I&rsquo;ll write it
on here.</p></section><div></div><small>permalink: <a class=u-url href=https://bneil.me/posts/2021-05-28_rds-audit-service/>https://bneil.me/posts/2021-05-28_rds-audit-service/</a></small><div class=post-tags><nav class="nav tags"><ul class=tags><li><a href=/tags/rds>rds</a></li><li><a href=/tags/aws>aws</a></li><li><a href=/tags/golang>golang</a></li></ul></nav></div></article></main><footer><hr><a class=soc rel=me href=https://github.com/bneil title=Github><i data-feather=github></i></a>|<a class=soc rel=me href=https://twitter.com/benneil/ title=Twitter><i data-feather=twitter></i></a>|<a class=soc rel=me href=https://www.linkedin.com/in/readyplayer1/ title=LinkedIn><i data-feather=linkedin></i></a>|<a class=soc rel=me href=mailto:ben@neil-concepts.com title=Email><i data-feather=mail></i></a>|<a class=soc rel=me href=https://coderwall.com/bneil title=Coderwall><i data-feather=code></i></a>|<a class=soc rel=me href=https://medium.com/@bneil/about title=Medium><i data-feather=book></i></a>|<a class=soc rel=me href=https://bneil.me/index.xml title=rss><i data-feather=rss></i></a>|⚡️
2022 © bneil | site was last updated: Aug 19, 2022</footer><link rel=webmention href=https://webmention.io/bneil.me/webmention><link rel=pingback href=https://webmention.io/bneil.me/xmlrpc><div class=h-card style=display:none><span class=p-name>Ben Neil</span>
<span class=p-given-name>Ben</span>
<abbr class=p-additional-name>E.</abbr>
<span class=p-family-name>Neil</span>
<span class=p-nickname>bneil</span> (IRC)
<img class=u-photo src=https://bneil.me/images/avatar.gif>
<a class=u-url href=https://bneil.me>w</a>,
<a class=u-email href=mailto:ben@neil-conceptscom>e</a><div class=p-category>programmer</div><div class=p-note>Now is tea time</div></div><script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "cc4d2eca67bc471d83269a9e66e60551"}'></script>
<script>var clicky_site_ids=clicky_site_ids||[];clicky_site_ids.push(101323590)</script><script async src=//static.getclicky.com/js></script><noscript><p><img alt=Clicky width=1 height=1 src=//in.getclicky.com/101323590ns.gif></p></noscript><script>feather.replace()</script></div></body></html>